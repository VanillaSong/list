<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Songlist Vanilla Bun</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
	<style>
		:root {
			--bg-color: #2d2d2d;
			--header-bg: #333;
			--text-color: #fff;
			--button-bg: #444;
			--button-hover: #555;
			--border-color: #444;
			--row-alt-bg: #333;
			--pagination-bg: #333;
			--pagination-border: #444;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: Arial, sans-serif;
		}

		body {
			background-color: var(--bg-color);
			color: var(--text-color);
			padding: 20px;
			position: relative;
			min-height: 100vh;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
		}

		.header {
			display: flex;
			align-items: center;
			background-color: var(--header-bg);
			padding: 10px 15px;
			border-radius: 5px 5px 0 0;
			gap: 10px;
			position: sticky;
			top: 0;
			z-index: 100;
			flex-wrap: wrap;
		}

		.search-container {
			display: flex;
			align-items: center;
			background-color: #444;
			border-radius: 5px;
			padding: 5px 10px;
			flex: 1;
			min-width: 200px;
			position: relative;
		}

		.search-icon {
			margin-right: 5px;
			color: #999;
		}

		.search-input {
			flex-grow: 1;
			background: transparent;
			border: none;
			color: var(--text-color);
			outline: none;
			padding: 5px 0;
		}

		.search-clear {
			background: transparent;
			border: none;
			color: #999;
			cursor: pointer;
			padding: 0 5px;
		}

		.icon-buttons {
			display: flex;
			gap: 5px;
			flex-wrap: wrap;
		}

		.icon-button {
			width: 30px;
			height: 30px;
			background-color: var(--button-bg);
			border-radius: 5px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: background-color 0.2s;
			flex-shrink: 0;
		}

		.icon-button:hover {
			background-color: var(--button-hover);
		}

		.icon-button img {
			width: 20px;
			height: 20px;
			object-fit: contain;
		}

		.refresh-btn {
			background-color: var(--button-bg);
			color: white;
			border: none;
			padding: 6px 12px;
			border-radius: 4px;
			cursor: pointer;
			white-space: nowrap;
		}

		.refresh-btn:hover {
			background-color: var(--button-hover);
		}

		/* === –®–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã === */
		.table-header-row {
			display: grid;
			grid-template-columns: minmax(200px, 1fr) minmax(200px, 1fr) 120px 120px;
			background-color: var(--header-bg);
			border-top: 1px solid var(--border-color);
			border-bottom: 1px solid var(--border-color);
			position: sticky;
			top: 40px;
			z-index: 99;
		}

		.table-header-cell {
			padding: 12px 15px;
			font-weight: normal;
			cursor: pointer;
			text-align: left;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			background-color: var(--header-bg);
		}

		.table-header-cell:nth-child(3),
		.table-header-cell:nth-child(4) {
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.table-header-cell:hover {
			background-color: #444;
		}

		/* === –¢–∞–±–ª–∏—Ü–∞ === */
		.table-container {
			overflow-x: auto;
		}

		.table-container {
			overflow-x: auto;
		}
		
		table {
			width: 100%;
			border-collapse: collapse;
			background-color: var(--bg-color);
			border-top: 1px solid var(--border-color);
			margin-top: 0;
			table-layout: fixed;
		}

		td {
			padding: 12px 15px;
			border-bottom: 1px solid var(--border-color);
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		td:nth-child(1) { width: calc(50% - 60px); }
		td:nth-child(2) { width: calc(50% - 60px); }
		td:nth-child(3) { width: 120px; }
		td:nth-child(4) {
			width: 120px; /* –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä —Å–¥–µ–ª–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü –∫–∞–∫ –º–æ–∂–Ω–æ —É–∂–µ */
			white-space: nowrap;
			overflow: visible;
		}

		tr:nth-child(even) {
			background-color: var(--row-alt-bg);
		}

		.flags-container {
			display: flex;
			gap: 5px;
			align-items: center;
			justify-content: center;
		}

		.flag-icon {
			width: 20px;
			height: 20px;
			object-fit: contain;
		}

		.request-button {
			background-color: var(--button-bg);
			color: var(--text-color);
			border: none;
			padding: 6px 12px;
			border-radius: 4px;
			cursor: pointer;
			transition: background-color 0.2s;
			text-align: center;
			white-space: nowrap;
		}

		.request-button:hover {
			background-color: var(--button-hover);
		}

		.hidden {
			display: none;
		}

		/* === –ü–∞–≥–∏–Ω–∞—Ü–∏—è === */
		.pagination {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 15px;
			padding: 15px;
			background-color: var(--pagination-bg);
			border-top: 1px solid var(--border-color);
			border-bottom: 1px solid var(--border-color);
			position: sticky;
			bottom: 0;
			z-index: 99;
			margin-top: 10px;
			flex-wrap: nowrap;			
		}

		/* –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ */
		.pagination-top {
			display: flex;
			align-items: center;
			gap: 15px;
			flex: 1;
			justify-content: center;
			min-width: 0;
		}

		.items-per-page {
			display: flex;
			align-items: center;
			gap: 5px;
			white-space: nowrap;
			margin-right: auto;
		}

		.items-per-page label {
			font-size: 14px;
			white-space: nowrap;
		}

		.items-per-page select {
			background-color: var(--button-bg);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			padding: 4px 8px;
			border-radius: 4px;
			cursor: pointer;
		}

		.page-info {
			font-size: 14px;
			white-space: nowrap;
			text-align: center;
			margin-left: auto; /* –ø—Ä–∏–∂–∏–º–∞–µ—Ç –≤–ø—Ä–∞–≤–æ */
			margin-right: auto;
		}

		.page-controls {
			display: flex;
			gap: 10px;
			white-space: nowrap;
			margin-left: auto;
		}

		.page-btn {
			background-color: var(--button-bg);
			color: var(--text-color);
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			cursor: pointer;
			transition: background-color 0.2s;
		}

		.page-btn:hover {
			background-color: var(--button-hover);
		}

		.page-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		/* === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ === */
		.modal {
			display: none;
			position: fixed;
			z-index: 500;
			padding-top: 80px;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0,0,0,0.6);
		}

		.modal-content {
			background-color: var(--header-bg); /* —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å */
			margin: auto;
			padding: 20px;
			border-radius: 12px;
			width: 90%;
			max-width: 400px;
			color: #fff;
			text-align: center;
			box-shadow: 0 0 15px rgba(0,0,0,0.4);
		}

		/* –ö–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
		.modal-buttons {
			display: flex;
			gap: 10px;
			margin-top: 16px;
			justify-content: center;
		}

		.modal-btn {
			margin-top: 15px;
			background: var(--button-bg);
			border: none;
			color: #fff;
			padding: 10px 16px;
			border-radius: 6px;
			cursor: pointer;
			transition: background 0.2s;
		}
		.modal-btn:hover {
			background: var(--button-hover);
		}

		/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–æ–∫ –∏ —Ç–µ–∫—Å—Ç–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π */
		.donate-links {
			margin: 12px 0;
			font-size: 14px;
			line-height: 1.4;
			color: #ccc;
		}

		.donate-links a {
			color: #B3DBF2;
			text-decoration: underline;
			display: block;
			margin: 4px 0;
		}

		.donate-links a:hover {
			color: #fff;
		}

		/* –¢–µ–∫—Å—Ç —Å –∫–∞—Ä—Ç–æ–π (–Ω–µ —Å—Å—ã–ª–∫–∞) */
		.modal-donation {
			margin-top: 18px;
			font-size: 14px;
			color: #ccc;
			line-height: 1.4;
			word-break: break-word;
			overflow-wrap: anywhere;
		}

		/* === Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ === */
		.toast {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(30,30,30,0.95);
			color: #fff;
			padding: 8px 18px;
			border-radius: 8px;
			font-size: 14px;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
			z-index: 1000;
		}

		.toast.show {
			opacity: 1;
		}

		#refreshBtn {
		    display: none !important;
		}

		/* === –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è === */
		@media (max-width: 768px) {
			body {
				padding: 10px;
			}
			
			.refresh-btn {
				display: none;
			}
			
			.container {
				width: 100%;
			}

			.header {
				flex-direction: column;
				align-items: stretch;
				gap: 15px;
				padding: 15px;
			}

			.search-container {
				width: 100%;
				order: 1;
			}

			.icon-buttons {
				order: 2;
				justify-content: center;
				overflow-x: auto;
				padding-bottom: 5px;
				-webkit-overflow-scrolling: touch;
				scrollbar-width: none;
			}

			.icon-buttons::-webkit-scrollbar {
				display: none;
			}

			.table-header-row {
				grid-template-columns: minmax(120px, 1fr) minmax(120px, 1fr) 80px 100px;
			}
			
			td:nth-child(1) { width: 40%; }
			td:nth-child(2) { width: 40%; }
			td:nth-child(3) { 
				width: 0;
				display: none;
				padding: 0;
				border: none;
			}
			td:nth-child(4) { 
				width: 20%;
				min-width: 80px;
			}
			
			.table-header-cell,
			td {
				padding: 10px 6px;
				font-size: 14px;
			}
			
			.request-button {
				padding: 6px 8px; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –∫–Ω–æ–ø–∫–∏ */
				font-size: 12px; /* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç */
				width: 100%; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏ */
				box-sizing: border-box;
			}

			.table-container {
				margin: 0 -10px;
				padding: 0 10px;
			}

			td {
				padding: 10px 8px;
				font-size: 14px;
				white-space: normal;
				word-break: break-word;
			}

			.flags-container,
			.flag-icon {
				display: none !important;
			}

			.request-button {
				padding: 8px 12px;
				font-size: 13px;
			}

			.pagination {
				flex-direction: column;
				align-items: stretch;
				gap: 10px;
				padding: 15px 10px;
				
			}

			.pagination-top {
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 15px;
				flex-wrap: wrap;
			}

			.items-per-page {
				display: flex;
				align-items: center;
				gap: 5px;
				margin: 0;
			}
			
			.page-info {
				margin: 0;
				text-align: center;
			}

			.items-per-page label,
			.page-info {
				font-size: 14px;
			}

			.items-per-page select {
				font-size: 14px;
				padding: 6px 8px;
			}

			.page-controls {
				display: flex;
				gap: 10px;
				justify-content: center;
				width: 100%;
				flex-wrap: wrap;
			}

			.page-btn {
				padding: 8px 12px;
				font-size: 14px;
				flex: 1;
				min-width: 40px;
			}

			.modal-content {
				margin: 20px;
				padding: 15px;
			}

			.modal-buttons {
				flex-direction: column;
			}
		}

		@media (max-width: 480px) {
			
			.table-header-row {
				grid-template-columns: minmax(100px, 1fr) minmax(100px, 1fr) 60px 80px;
			}
			
			td:nth-child(1) { width: 40%; }
			td:nth-child(2) { width: 40%; }
			td:nth-child(3) { 
				width: 0;
				display: none;
				padding: 0;
				border: none;
			}
			td:nth-child(4) { 
				width: 20%;
				min-width: 70px;
			}

			.table-header-cell {
				padding: 6px 4px;
				font-size: 12px;
			}

			td {
				padding: 6px 4px;
				font-size: 12px;
			}

			.request-button {
				padding: 4px 6px;
				font-size: 11px;
			}

			.page-btn {
				padding: 6px 8px;
				font-size: 12px;
			}
		}
	</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Search">
                <button class="search-clear" id="clearSearch">√ó</button>
            </div>
            <div class="icon-buttons">
                <div class="icon-button" data-filter="earth"><img src="icons/earth.png" alt="Other" title="–ù–∞ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–∞—Ö"></div>
                <div class="icon-button" data-filter="film"><img src="icons/film.png" alt="Film" title="–ò–∑ –∫–∏–Ω–æ—Ñ–∏–ª—å–º–æ–≤"></div>
                <div class="icon-button" data-filter="mult"><img src="icons/mult.png" alt="Animation" title="–ò–∑ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–æ–≤"></div>
                <div class="icon-button" data-filter="piano"><img src="icons/piano.png" alt="Lyrics" title="–õ–∏—Ä–∏—á–µ—Å–∫–∏–µ"></div>
                <div class="icon-button" data-filter="dance"><img src="icons/dance.png" alt="Dance" title="–ü–æ—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å"></div>
                <div class="icon-button" data-filter="rock"><img src="icons/rock.png" alt="Rock" title="–†–û–ö"></div>
                <div class="icon-button" data-filter="pop"><img src="icons/pop.png" alt="Pop" title="–ü–û–ü"></div>
                <div class="icon-button" data-filter="folk"><img src="icons/folk.png" alt="Folk" title="–ù–∞—Ä–æ–¥–Ω—ã–µ"></div>
                <div class="icon-button" data-filter="retro"><img src="icons/retro.png" alt="Retro" title="–†–µ—Ç—Ä–æ"></div>
            </div>
            <button class="refresh-btn" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>

        <div class="table-header-row">
            <div class="table-header-cell" id="sortTitle">Title</div>
            <div class="table-header-cell" id="sortArtist">Artist</div>
            <div class="table-header-cell"></div>
            <div class="table-header-cell"></div>
        </div>

        <div class="table-container">
            <table id="musicTable">
                <tbody id="tableBody"></tbody>
            </table>
        </div>

		<div class="pagination">
			<div class="pagination-top">
				<div class="items-per-page">
					<label for="itemsPerPage">Items per page:</label>
					<select id="itemsPerPage">
						<option value="10">10</option>
						<option value="25">25</option>
						<option value="50">50</option>
						<option value="100">100</option>
						<option value="-1">All</option>
					</select>
				</div>
				<div class="page-info" id="pageInfo">1 ‚Äì 10 of 0</div>
			</div>
			<div class="page-controls">
				<button class="page-btn" id="firstPage">¬´</button>
				<button class="page-btn" id="prevPage">‚Äπ</button>
				<button class="page-btn" id="nextPage">‚Ä∫</button>
				<button class="page-btn" id="lastPage">¬ª</button>
			</div>
		</div>
    </div>

    <div id="requestModal" class="modal">
        <div class="modal-content">
            <p>–ó–∞–∫–∞–∑–∞—Ç—å –ø–µ—Å–Ω—é "<span id="modalArtistTitle">Artist ‚Äì Title</span>" –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ—Ç 200 —Ä—É–±–ª–µ–π, —Å–∏–≥–Ω–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç 500 —Ä—É–±–ª–µ–π</p>
            <div class="donate-links">
                <a href="https://www.donationalerts.com/r/vanilla_bun_" target="_blank">https://www.donationalerts.com/r/vanilla_bun_</a>
                <a href="https://new.donatepay.ru/@vanillabun" target="_blank">https://new.donatepay.ru/@vanillabun</a>
                –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É –´-–ë–∞–Ω–∫: 0000 0000 0000 0000 (–ò–º—è –§.)
            </div>
            <div class="modal-buttons">
                <button id="cancelButton">Cancel</button>
                <button id="copyButton">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏</button>
            </div>
        </div>
    </div>
	<div id="toast" class="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>

	<script>
		// === –ú–∞–ø–ø–∏–Ω–≥–∏ ===
		const attrToIcon = {
			"–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ": "uk.png",
			"–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–µ": "fr.png",
			"–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–µ": "it.png",
			"–ú–æ–ª–¥–∞–≤—Å–∫–∏–µ": "md.png",
			"–£–∫—Ä–∞–∏–Ω—Å–∫–∏–µ": "ua.png",
			"–ò–∑ –∫–∏–Ω–æ—Ñ–∏–ª—å–º–æ–≤": "film.png",
			"–ò–∑ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–æ–≤": "mult.png",
			"–õ–∏—Ä–∏—á–µ—Å–∫–∏–µ": "piano.png",
			"–ü–æ—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å": "dance.png",
			"–†–û–ö": "rock.png",
			"–ü–û–ü": "pop.png",
			"–ù–∞—Ä–æ–¥–Ω—ã–µ": "folk.png",
			"–†–µ—Ç—Ä–æ": "retro.png"
		};

		const hiddenInTable = new Set([
			"–ù–∞ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–∞—Ö",
			"–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ",
			"A cappella",
			"–ö–æ–ª—ã–±–µ–ª—å–Ω—ã–µ"
		]);

		const attrPriority = [
			"–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ", "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–µ", "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–µ", "–ú–æ–ª–¥–∞–≤—Å–∫–∏–µ", "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–µ",
			"–ò–∑ –∫–∏–Ω–æ—Ñ–∏–ª—å–º–æ–≤",
			"–ò–∑ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–æ–≤",
			"–õ–∏—Ä–∏—á–µ—Å–∫–∏–µ",
			"–ü–æ—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å",
			"–†–û–ö",
			"–ü–û–ü",
			"–ù–∞—Ä–æ–¥–Ω—ã–µ",
			"–†–µ—Ç—Ä–æ"
		];

		const filterMap = {
			'earth': ["–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ", "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–µ", "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–µ", "–ú–æ–ª–¥–∞–≤—Å–∫–∏–µ", "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–µ"],
			'film': ["–ò–∑ –∫–∏–Ω–æ—Ñ–∏–ª—å–º–æ–≤"],
			'mult': ["–ò–∑ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–æ–≤"],
			'piano': ["–õ–∏—Ä–∏—á–µ—Å–∫–∏–µ"],
			'dance': ["–ü–æ—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å"],
			'rock': ["–†–û–ö"],
			'pop': ["–ü–û–ü"],
			'folk': ["–ù–∞—Ä–æ–¥–Ω—ã–µ"],
			'retro': ["–†–µ—Ç—Ä–æ"]
		};

		const fallbackIcon = "unknown.png";

		// === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
		let allSongs = [];
		let filteredSongs = [];
		let currentPage = 1;
		let itemsPerPage = 10;
		let sortColumn = null;
		let sortDirection = 'asc';
		let activeFilters = [];

		// === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ===
		const modal = document.getElementById('requestModal');
		const modalText = document.getElementById('modalArtistTitle');
		const cancelButton = document.getElementById('cancelButton');
		const copyButton = document.getElementById('copyButton');
		const toast = document.getElementById('toast');

		function openModal(title, artist) {
			modalText.textContent = `${artist ? artist + " ‚Äì " : ""}${title}`;
			modal.style.display = "block";
		}

		function closeModal() {
			modal.style.display = "none";
		}

		cancelButton.addEventListener('click', closeModal);

		copyButton.addEventListener('click', () => {
			const text = modalText.textContent;
			navigator.clipboard.writeText(text).then(() => {
				showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
			});
		});

		function showToast(msg) {
			toast.textContent = msg;
			toast.classList.add('show');
			setTimeout(() => toast.classList.remove('show'), 2000);
		}

		window.addEventListener('click', (e) => {
			if (e.target === modal) closeModal();
		});

		// === –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã ===
		function renderTable() {
			const tbody = document.getElementById('tableBody');
			tbody.innerHTML = '';

			const startIndex = (currentPage - 1) * itemsPerPage;
			const endIndex = Math.min(startIndex + itemsPerPage, filteredSongs.length);

			for (let i = startIndex; i < endIndex; i++) {
				const row = filteredSongs[i];
				const title = row.title || '';
				const artist = row.artist || '';
				const attrs = row.attributes ? row.attributes.split(',').map(s => s.trim()) : [];

				const visibleAttrs = attrs.filter(attr => !hiddenInTable.has(attr));
				visibleAttrs.sort((a, b) => {
					const ia = attrPriority.indexOf(a);
					const ib = attrPriority.indexOf(b);
					if (ia === -1 && ib === -1) return 0;
					if (ia === -1) return 1;
					if (ib === -1) return -1;
					return ia - ib;
				});

				let flagsHtml = '';
				if (visibleAttrs.length > 0) {
					flagsHtml = '<div class="flags-container">';
					visibleAttrs.forEach(attr => {
						const iconName = attrToIcon[attr] || fallbackIcon;
						flagsHtml += `<img class="flag-icon" src="icons/${iconName}" alt="${attr}">`;
					});
					flagsHtml += '</div>';
				}

				const tr = document.createElement('tr');
				const requestBtn = document.createElement('button');
				requestBtn.className = 'request-button';
				requestBtn.textContent = 'Request';
				requestBtn.addEventListener('click', () => openModal(title, artist));

				tr.innerHTML = `
					<td>${title}</td>
					<td>${artist}</td>
					<td>${flagsHtml}</td>
					<td></td>
				`;
				tr.querySelector('td:last-child').appendChild(requestBtn);
				tbody.appendChild(tr);
			}

			const pageInfo = document.getElementById('pageInfo');
			pageInfo.textContent = `${startIndex + 1} ‚Äì ${endIndex} of ${filteredSongs.length}`;

			const totalPages = Math.ceil(filteredSongs.length / itemsPerPage);
			document.getElementById('firstPage').disabled = currentPage === 1;
			document.getElementById('prevPage').disabled = currentPage === 1;
			document.getElementById('nextPage').disabled = currentPage >= totalPages;
			document.getElementById('lastPage').disabled = currentPage >= totalPages;
		}

		// === –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ===
		function filterSongs() {
			const term = document.getElementById('searchInput').value.toLowerCase().trim();

			filteredSongs = allSongs.filter(row => {
				const title = row.title.toLowerCase();
				const artist = row.artist.toLowerCase();
				const matchesSearch = title.includes(term) || artist.includes(term);
				if (!matchesSearch) return false;

				const songAttrs = new Set(row.attributes ? row.attributes.split(',').map(s => s.trim()) : []);
				for (const key of activeFilters) {
					const required = filterMap[key];
					if (!required.some(attr => songAttrs.has(attr))) return false;
				}
				return true;
			});

			currentPage = 1;
			renderTable();
		}

		// === –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ===
		function sortTable(column) {
			if (sortColumn === column) {
				sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
			} else {
				sortColumn = column;
				sortDirection = 'asc';
			}

			filteredSongs.sort((a, b) => {
				const valA = a[column].toLowerCase();
				const valB = b[column].toLowerCase();
				return sortDirection === 'asc'
					? valA.localeCompare(valB)
					: valB.localeCompare(valA);
			});

			renderTable();
		}

		// === –ó–∞–≥—Ä—É–∑–∫–∞ CSV ===
		function loadCSV() {
			Papa.parse('song-export.csv', {
				download: true,
				header: true,
				skipEmptyLines: true,
				complete: (results) => {
					allSongs = results.data.filter(row => row.active === 'true');
					localStorage.setItem('songsData', JSON.stringify(allSongs));
					localStorage.setItem('songsLastUpdate', new Date().toISOString());
					filterSongs();
				},
				error: (err) => {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV:', err);
					alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å song-export.csv');
				}
			});
		}

		// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
		document.addEventListener('DOMContentLoaded', () => {
			const cached = localStorage.getItem('songsData');
			if (cached) {
				allSongs = JSON.parse(cached);
				filterSongs();
			} else {
				loadCSV();
			}

			document.getElementById('searchInput').addEventListener('input', filterSongs);
			document.getElementById('clearSearch').addEventListener('click', () => {
				document.getElementById('searchInput').value = '';
				filterSongs();
			});
			document.getElementById('refreshBtn').addEventListener('click', loadCSV);

			document.getElementById('itemsPerPage').addEventListener('change', (e) => {
				const val = e.target.value;
				if (val === '-1') {
					itemsPerPage = filteredSongs.length; // –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë
				} else {
					itemsPerPage = parseInt(val, 10);
				}
				currentPage = 1;
				renderTable();
			});

			document.getElementById('firstPage').addEventListener('click', () => {
				currentPage = 1;
				renderTable();
			});
			document.getElementById('prevPage').addEventListener('click', () => {
				if (currentPage > 1) {
					currentPage--;
					renderTable();
				}
			});
			document.getElementById('nextPage').addEventListener('click', () => {
				const totalPages = Math.ceil(filteredSongs.length / itemsPerPage);
				if (currentPage < totalPages) {
					currentPage++;
					renderTable();
				}
			});
			document.getElementById('lastPage').addEventListener('click', () => {
				currentPage = Math.ceil(filteredSongs.length / itemsPerPage);
				renderTable();
			});

			document.getElementById('sortTitle').addEventListener('click', () => sortTable('title'));
			document.getElementById('sortArtist').addEventListener('click', () => sortTable('artist'));
			
			const iconButtons = document.querySelectorAll('.icon-button[data-filter]');
			iconButtons.forEach(btn => {
				const key = btn.dataset.filter;
				btn.addEventListener('click', () => {
					const index = activeFilters.indexOf(key);
					if (index === -1) {
						activeFilters.push(key);
						btn.style.backgroundColor = '#2D2D2D'; // –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–≤–µ—Ç
					} else {
						activeFilters.splice(index, 1);
						btn.style.backgroundColor = ''; // —Å–±—Ä–æ—Å
					}
					filterSongs();
				});
			});
		});
	</script>

</body>
</html>
